<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>偶像杯代币计算工具</title>
  <style>
  body { font-family: Arial, sans-serif; margin: 0; }
  nav {
    display: flex;
    background: #333;
    color: #fff;
  }
  nav button {
    flex: 1;
    padding: 12px;
    background: none;
    border: none;
    color: #fff;
    cursor: pointer;
  }
  nav button.active { background: #555; }

  .page { display: none; padding: 10px; }
  .page.active { display: flex; }

  .column {
    flex: 1;
    border: 1px solid #ccc;
    margin: 5px;
    padding: 10px;
    overflow-y: auto;
  }

  h2 { margin-top: 0; }

  .song {
    border: 1px solid #aaa;
    padding: 5px;
    margin: 5px 0;
    cursor: pointer;
  }

  .token-input input {
    width: 60px;
  }
  .song-card {
    display: flex;
    border: 1px solid #999;
    padding: 6px;
    margin-bottom: 6px;
    cursor: pointer;
  }

  .song-card:hover {
    background: #f3f3f3;
  }

  .song-cover {
    width: 100px;
    height: 100px;
    margin-right: 8px;
    flex-shrink: 0;
  }

  .song-info {
    flex: 1;
  }

  .song-title {
    font-weight: bold;
  }

  .song-effect {
    font-size: 13px;
    color: #555;
  }

  .token-row img {
    width: 24px;
    vertical-align: middle;
  }

  .token-row span {
    margin-right: 6px;
    font-size: 13px;
  }

  .tag {
    display: inline-block;
    padding: 2px 6px;
    font-size: 12px;
    border-radius: 4px;
    margin-right: 5px;
  }

  .tag-priority {
    background: #ddd;
  }

  .tag-suggest {
    background: #ffdfdf;
    color: #b00000;
  }

  button.disabled {
  background: #ccc;
  color: #666;
  cursor: not-allowed;
}

#toast {
  position: fixed;
  bottom: 30px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.8);
  color: #fff;
  padding: 10px 20px;
  border-radius: 6px;
  opacity: 0;
  transition: opacity 0.5s;
  pointer-events: none;
}

#toast.show {
  opacity: 1;
}

.token-diff-row img {
  width: 24px;
  vertical-align: middle;
}

.token-diff-row span {
  margin-right: 10px;
  font-size: 13px;
}

.token-negative {
  color: #c00000;
  font-weight: bold;
}

#practiceFilter {
  margin-bottom: 8px;
}

#practiceTable {
  width: 100%;
  font-size: 13px;
  border-collapse: collapse;
}

#practiceTable th {
  background: #f0f0f0;
}

#practiceTable td,
#practiceTable th {
  text-align: center;
}

/* 使用声明遮罩 */
#usageMask {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0, 0, 0, 0.6);
  z-index: 9999;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* 弹窗主体 */
#usageModal {
  width: 90%;
  max-width: 520px;
  background: #fff;
  border-radius: 8px;
  padding: 20px 24px;
  box-sizing: border-box;
}

#usageModal h2 {
  margin-top: 0;
  text-align: center;
}

.usage-content {
  font-size: 14px;
  line-height: 1.6;
  margin: 15px 0;
}

#agreeBtn {
  width: 100%;
  padding: 10px 0;
  background: #4caf50;
  color: #fff;
  border: none;
  border-radius: 4px;
  font-size: 15px;
  cursor: pointer;
}

#agreeBtn:hover {
  background: #43a047;
}

/* ===== 商店 · 练习次数提示卡 ===== */
.practice-card {
  margin: 10px 0 14px;
  padding: 10px 12px;
  border-radius: 8px;
  background: #f7f9ff;
  border: 2px solid #5c6bc0;
}

.practice-card2{
  margin: 10px 0 14px;
  padding: 10px 12px;
  border-radius: 8px;
  background: #f7f9ff;
  border: 2px solid #a11fc1;
}

.practice-title {
  font-size: 14px;
  font-weight: bold;
  color: #303f9f;
  margin-bottom: 6px;
}

.practice-value {
  font-size: 26px;
  font-weight: bold;
  color: #2c3e50;
  text-align: center;
}

.practice-note {
  margin-top: 6px;
  font-size: 12px;
  color: #666;
  text-align: center;
}

/* 不可购买 / 未定义 状态 */
.practice-card.invalid {
  background: #fff5f5;
  border-color: #c00000;
}

.practice-card.invalid .practice-value {
  color: #c00000;
}

/* ===== 页面底部信息栏 ===== */
.footer {
  width: 100%;
  padding: 12px 8px;
  text-align: center;
  font-size: 12px;
  color: #777;
  background: #f5f6f8;
  border-top: 1px solid #ddd;
  box-sizing: border-box;
}

.footer a {
  color: #5c6bc0;
  text-decoration: none;
  margin: 0 4px;
}

.footer a:hover {
  text-decoration: underline;
}

.footer-sep {
  margin: 0 6px;
  color: #aaa;
}
/* ===== 通用弹窗内容样式（复用 usageModal） ===== */
.modal-hidden {
  display: none;
}

.modal-close-btn {
  margin-top: 12px;
  width: 100%;
  padding: 8px 0;
  background: #5c6bc0;
  color: #fff;
  border: none;
  border-radius: 4px;
  font-size: 14px;
  cursor: pointer;
}

.modal-close-btn:hover {
  background: #3f51b5;
}

  </style>
</head>

<body>

<!-- 导航栏 -->
<nav>
  <button class="active" onclick="switchPage('operate')">操作页面</button>
  <button onclick="switchPage('wiki')">Wiki 页面</button>
  <button onclick="resetPage()">重置页面状态</button>

</nav>

<!-- 操作页面 -->
<div id="operate" class="page active">
  <!-- 库存区 -->
  <div class="column">
    <h2>库存区</h2>
    <h3>当前代币</h3>
    <div class="token-input">
    <div class="token-row">
      <img src="./coinpng/Da.png"> <input type="number" id="Da" value="100">
      <img src="./coinpng/Pa.png"> <input type="number" id="Pa" value="100">
      <img src="./coinpng/Vo.png"> <input type="number" id="Vo" value="100">
      <img src="./coinpng/Vi.png"> <input type="number" id="Vi" value="100">
      <img src="./coinpng/Me.png"> <input type="number" id="Me" value="100">
    <h3>可用于购买课程的代币：</h3>
    <div id="tokenDiff"></div>
  </div>
</div>


    <h3>已购买歌曲</h3>
    <div id="inventory"></div>
  </div>

  <!-- 歌曲商店 -->
  <div class="column">
    <h2>歌曲商店</h2>

    <!-- 时间按钮 -->
    <div>
      <button data-time="出道战倒数第八个回合后" onclick="setTime('出道战倒数第八个回合后'), onTimeButtonClick(this)">出道战倒数第八个回合后</button>
      <button data-time="第二年一月前半" onclick="setTime('第二年一月前半'), onTimeButtonClick(this)">第二年一月前半</button>
      <button data-time="第二年七月前半" onclick="setTime('第二年七月前半'), onTimeButtonClick(this)">第二年七月前半</button>
      <button data-time="第三年一月前半" onclick="setTime('第三年一月前半'), onTimeButtonClick(this)">第三年一月前半</button>
      <button data-time="第三年七月前半" onclick="setTime('第三年七月前半'), onTimeButtonClick(this)">第三年七月前半</button>
      
    </div>

<p>当前时间：<span id="currentTime">未设定</span></p>
<p>当前买歌次数：<span id="buyCount">0</span></p>

<!-- 重点提示卡 -->
<div id="practiceHint" class="practice-card">
  <div class="practice-title">购买当前歌曲前 → 还需购买课程次数</div>
  <div class="practice-value" id="needPractice">-</div>
  <div class="practice-note">※ 如您卡歌，第一次购买的歌曲将不计入当前买歌次数</div>
</div>

<!-- 下一首歌练习提示卡 -->
<div id="nextPracticeHint" class="practice-card2">
  <div class="practice-title">
    购买当前歌曲后 → 下一首歌曲前还需购买课程次数
  </div>
  <div class="practice-value" id="nextNeedPractice">-</div>
  <div class="practice-note">
    ※ 用于判断您剩余的代币是否足以继续买歌
  </div>
</div>


    <p>建议购买歌曲总消耗代币：</p>
    <div id="suggestCost"></div>
    <div id="shop"></div>
  </div>
</div>

<!-- Wiki 页面 -->
<div id="wiki" class="page">
  <!-- 歌曲库 -->
  <div class="column">
    <h2>歌曲库</h2>
    <div id="songLibraryView"></div>
  </div>

  <!-- 练习表 -->
  <div class="column">
<h3>练习表</h3>

<div id="practiceFilter">
  <label>筛选时间：</label>
  <select id="practiceTimeSelect"></select>
</div>

<table id="practiceTable" border="1" cellspacing="0" cellpadding="4">
  <thead>
    <tr>
      <th>买歌次数</th>
      <th>购买下一首歌前所需练习次数</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

  </div>
</div>

<script>
/* ================= 数据区 ================= */

// 歌曲库
const songLibrary = [
  //自动获取的一个
  {
    id: 1,
    name: "Make debut!",
    effect: {
      instant: "全部种类代币+10",
      afterLive: "擅长率加成+5%"
    },
    cover: "Make_debut!.png",
    cost: { Da:0, Pa:0, Vo:0, Vi:0, Me:0 },
    priority: 0,
    suggest: false
  },
  //出道战倒数八回合后
  {
  id: 2,
  name: "青春在等待",
  effect: {
    instant: "力量+22",
    afterLive: "友情加成+5%"
  },
  cover: "青春在等待.png",
  cost: { Da:0, Pa:0, Vo:32, Vi:0, Me:12 },
  priority: 5,
  suggest: true
  },
  {
    id: 3,
    name: "全速！前进！优俊偶像Power☆",
    effect: {
      instant: "速度+22",
      afterLive: "友情加成+5%"
    },
    cover: "全速前进！优俊偶像Power☆.png",
    cost: { Da:32, Pa:0, Vo:0, Vi:12, Me:0 },
    priority: 5,
    suggest: true
  },
  {
    id: 4,
    name: "RUN×RUN!",
    effect: {
      instant: "pt+22",
      afterLive: "友情加成+5%"
    },
    cover: "RUN×RUN!.png",
    cost: { Da:14, Pa:0, Vo:0, Vi:12, Me:12 },
    priority: 5,
    suggest: true
  },
  {
    id: 5,
    name: "站位零号！排名第一！",
    effect: {
      instant: "速度加成+1",
      afterLive: "连续率提升等级+1"
    },
    cover: "站位零号！排名第一！.png",
    cost: { Da:21, Pa:0, Vo:0, Vi:21, Me:0 },
    priority: 4,
    suggest: true
  },
  {
    id: 6,
    name: "Go This Way",
    effect: {
      instant: "力量加成+1",
      afterLive: "连续率提升等级+1"
    },
    cover: "Go This Way.png",
    cost: { Da:0, Pa:0, Vo:21, Vi:0, Me:21 },
    priority: 3,
    suggest: true
  },

  {
    id: 7,
    name: "相信奇迹！",
    effect: {
      instant: "智力加成+1",
      afterLive: "擅长率加成+5%"
    },
    cover: "相信奇迹！.png",
    cost: { Da:0, Pa:21, Vo:0, Vi:0, Me:21 },
    priority: 3,
    suggest: true
  },

  {
    id: 8,
    name: "领跑到底！Fallin' Love",
    effect: {
      instant: "毅力加成+1",
      afterLive: "连续率提升等级+1"
    },
    cover: "领跑到底！Fallin' Love.png",
    cost: { Da:21, Pa:0, Vo:0, Vi:21, Me:0 },
    priority: 1,
    suggest: false

  },
  {
    id: 9,
    name: "Ring Ring 日记",
    effect: {
      instant: "耐力加成+1",
      afterLive: "连续率提升等级+1"
    },
    cover: "Ring Ring 日记.png",
    cost: { Da:0, Pa:21, Vo:0, Vi:21, Me:0 },
    priority: 1,
    suggest: false
  },

  //第二年一月前半
  {
    id: 10,
    name: "追逐梦想！",
    effect: {
      instant: "pt加成+2",
      afterLive: "擅长率加成+5%"
    },
    cover: "奔向梦想！.png",
    cost: { Da:0, Pa:21, Vo:0, Vi:21, Me:0 },
    priority: 4,
    suggest: true
  },
  {
    id: 11,
    name: "A・NO・NE",
    effect: {
      instant: "毅力加成+2",
      afterLive: "擅长率加成+5%"
    },
    cover: "A・NO・NE.png",
    cost: { Da:42, Pa:0, Vo:0, Vi:21, Me:0 },
    priority: 3,
    suggest: false
  },
  {
    id: 12,
    name: "我们的Blue Bird Days",
    effect: {
      instant: "速度加成+2",
      afterLive: "擅长率加成+5%"
    },
    cover: "我们的青鸟时光.png",
    cost: { Da:21, Pa:0, Vo:0, Vi:42, Me:0 },
    priority: 4,
    suggest: true
  },

//第二年七月前半
  {
    id: 13,
    name: "树荫下的声援",
    effect: {
      instant: "智力加成+2",
      afterLive: "连续率提升等级+1"
    },
    cover: "树荫下的声援.png",
    cost: { Da:0, Pa:42, Vo:0, Vi:0, Me:21 },
    priority: 4,
    suggest: true
  },
  {
    id: 14,
    name: "Grow up shine!",
    effect: {
      instant: "pt加成+3",
      afterLive: "连续率提升等级+1"
    },
    cover: "Grow up shine!.png",
    cost: { Da:21, Pa:0, Vo:21, Vi:0, Me:21 },
    priority: 4,
    suggest: true
  },
  {
    id: 15,
    name: "欢乐蹦跳 晴空万里！",
    effect: {
      instant: "耐力加成+2",
      afterLive: "连续率提升等级+1"
    },
    cover: "欢乐蹦跳 晴空万里！.png",
    cost: { Da:0, Pa:42, Vo:21, Vi:0, Me:0 },
    priority: 3,
    suggest: false
  },
  {
    id: 16,
    name: "七彩的景色",
    effect: {
      instant: "力量加成+2",
      afterLive: "擅长率加成+5%"
    },
    cover: "七彩的景色.png",
    cost: { Da:0, Pa:0, Vo:21, Vi:0, Me:42 },
    priority: 4,
    suggest: true
},

  //第三年一月前半
  {
  id: 17,
  name: "Fanfare for Future!",
  effect: {
    instant: "毅力+26",
    afterLive: "友情加成+10%"
  },
  cover: "Fanfare for Future!.png",
  cost: { Da:26, Pa:0, Vo:0, Vi:42, Me:0 },
  priority: 6,
  suggest: true
},
{
  id: 18,
  name: "最爱的宝盒",
  effect: {
    instant: "速度+26",
    afterLive: "友情加成+10%"
  },
  cover: "最爱的宝盒.png",
  cost: { Da:42, Pa:0, Vo:0, Vi:26, Me:0 },
  priority: 6,
  suggest: true
},
{
  id: 19,
  name: "梦想天空",
  effect: {
    instant: "智力+22",
    afterLive: "友情加成+5%"
  },
  cover: "梦想天空.png",
  cost: { Da:0, Pa:22, Vo:0, Vi:0, Me:22 },
  priority: 5,
  suggest: true
},
{
  id: 20,
  name: "PRESENT MARCH",
  effect: {
    instant: "力量+22",
    afterLive: "友情加成+5%"
  },
  cover: "PRESENT MARCH.png",
  cost: { Da:0, Pa:0, Vo:22, Vi:0, Me:22 },
  priority: 5,
  suggest: true
},
{
  id: 21,
  name: "世界由我们掌控",
  effect: {
    instant: "耐力+22",
    afterLive: "友情加成+5%"
  },
  cover: "世界由我们掌控.png",
  cost: { Da:0, Pa:32, Vo:12, Vi:0, Me:0 },
  priority: 5,
  suggest: true
},
{
  id: 22,
  name: "春空BLUE",
  effect: {
    instant: "毅力+22",
    afterLive: "友情加成+5%"
  },
  cover: "春空BLUE.png",
  cost: { Da:12, Pa:0, Vo:0, Vi:32, Me:0 },
  priority: 5,
  suggest: true
},
//免费获取
{
  id: 23,
  name: "GIRLS' LEGEND U",
  effect: {
    instant: "全部基础属性+10",
    afterLive: "友情加成+10%"
  },
  cover: "GIRLS' LEGEND U.png",
  cost: { Da:0, Pa:0, Vo:0, Vi:0, Me:0 },
  priority: 0,
  suggest: null
}



];

// 练习表（模板）
const practiceTable = [
  { time: "出道战倒数第八个回合后", buy: 0, need: 1 },
  { time: "出道战倒数第八个回合后", buy: 1, need: 2 },
  { time: "出道战倒数第八个回合后", buy: 2, need: 3 },
  { time: "出道战倒数第八个回合后", buy: 3, need: 4 },
  { time: "出道战倒数第八个回合后", buy: 4, need: 4 },
  { time: "出道战倒数第八个回合后", buy: 5, need: 2 },
  { time: "出道战倒数第八个回合后", buy: 6, need: 3 },
  { time: "出道战倒数第八个回合后", buy: 7, need: null },

  { time: "第二年一月前半", buy: 0, need: 2 },
  { time: "第二年一月前半", buy: 1, need: 2 },
  { time: "第二年一月前半", buy: 2, need: 2 },
  { time: "第二年一月前半", buy: 3, need: 4 },
  { time: "第二年一月前半", buy: 4, need: 5 },
  { time: "第二年一月前半", buy: 5, need: 2 },
  { time: "第二年一月前半", buy: 6, need: 2 },
  { time: "第二年一月前半", buy: 7, need: 4 },
  { time: "第二年一月前半", buy: 8, need: 5 },
  { time: "第二年一月前半", buy: 9, need: 2 },
  { time: "第二年一月前半", buy: 10, need: 2 },


  { time: "第二年七月前半", buy: 0, need: 2 },
  { time: "第二年七月前半", buy: 1, need: 2 },
  { time: "第二年七月前半", buy: 2, need: 2 },
  { time: "第二年七月前半", buy: 3, need: 4 },
  { time: "第二年七月前半", buy: 4, need: 5 },
  { time: "第二年七月前半", buy: 5, need: 2 },
  { time: "第二年七月前半", buy: 6, need: 2 },
  { time: "第二年七月前半", buy: 7, need: 4 },
  { time: "第二年七月前半", buy: 8, need: 5 },
  { time: "第二年七月前半", buy: 9, need: 2 },
  { time: "第二年七月前半", buy: 10, need: 2 },
  { time: "第二年七月前半", buy: 11, need: 2 },
  { time: "第二年七月前半", buy: 12, need: 4 },
  { time: "第二年七月前半", buy: 13, need: 5 },  
  { time: "第二年七月前半", buy: 14, need: 2 },  

  
  { time: "第三年一月前半",buy: 0, need: 2 },
  { time: "第三年一月前半",buy: 1, need: 2 },
  { time: "第三年一月前半",buy: 2, need: 2 },
  { time: "第三年一月前半",buy: 3, need: 4 },
  { time: "第三年一月前半",buy: 4, need: 5 },
  { time: "第三年一月前半",buy: 5, need: 2 },
  { time: "第三年一月前半",buy: 6, need: 2 },
  { time: "第三年一月前半",buy: 7, need: 4 },
  { time: "第三年一月前半",buy: 8, need: 5 },

  { time: "第三年一月前半",buy: 9, need: 2 },
  { time: "第三年一月前半",buy: 10, need: 2 },
  { time: "第三年一月前半",buy: 11, need: 2 },
  { time: "第三年一月前半",buy: 12, need: 4 },
  { time: "第三年一月前半",buy: 13, need: 5 },  
  { time: "第三年一月前半",buy: 14, need: 2 },  
  { time: "第三年一月前半",buy: 15, need: 2 },  
  { time: "第三年一月前半",buy: 16, need: 4 },  
  { time: "第三年一月前半",buy: 17, need: 5 },  

  { time: "第三年一月前半",buy: 18, need: 2 },  
  { time: "第三年一月前半",buy: 19, need: 2 },  
  { time: "第三年一月前半",buy: 20, need: 2 },  

  { time: "第三年七月前半", buy: 0, need: 2 },
  { time: "第三年七月前半", buy: 1, need: 2 },
  { time: "第三年七月前半", buy: 2, need: 2 },
  { time: "第三年七月前半", buy: 3, need: 4 },
  { time: "第三年七月前半", buy: 4, need: 3 },
  { time: "第三年七月前半", buy: 5, need: 2 },
  { time: "第三年七月前半", buy: 6, need: 2 },
  { time: "第三年七月前半", buy: 7, need: 2 },
  { time: "第三年七月前半", buy: 8, need: 4 },
  { time: "第三年七月前半", buy: 9, need: 3 },
  { time: "第三年七月前半", buy: 10, need: 2 },
  { time: "第三年七月前半", buy: 11, need: 2 },
  { time: "第三年七月前半", buy: 12, need: 2 },
  { time: "第三年七月前半", buy: 13, need: 4 },
  { time: "第三年七月前半", buy: 14, need: 3 },
  { time: "第三年七月前半", buy: 15, need: 2 },
  { time: "第三年七月前半", buy: 16, need: 2 },
  { time: "第三年七月前半", buy: 17, need: 2 },
  { time: "第三年七月前半", buy: 18, need: 4 },
  { time: "第三年七月前半", buy: 19, need: 3 },
  { time: "第三年七月前半", buy: 20, need: 2 },

];

let shopSongs = [];
let inventory = [];
let buyCount = 0;
let currentTime = "";

let disabledTimes = new Set();      // 已点击过的时间按钮
let isCardSongMode = false;        // 是否卡歌（仅对当前时间有效）
let ignoreNextBuyCount = false;    // 下一次买歌是否不计入买歌次数


//商店刷新配置表
const shopRefreshMap = {
  "出道战倒数第八个回合后": [2,3,4,5,6,7,8,9],
  "第二年一月前半": [10,11,12],
  "第二年七月前半": [13,14,15,16],
  "第三年一月前半": [17,18,19,20,21,22]
};


/* ================= 页面逻辑 ================= */

function switchPage(id) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
  event.target.classList.add('active');
}

function setTime(time) {
  currentTime = time;
  document.getElementById("currentTime").innerText = time;

  // 切时间点时，买歌次数重置
  buyCount = 0;
  document.getElementById("buyCount").innerText = buyCount;

  const ids = shopRefreshMap[time] || [];

  //找出当前时间新解锁的歌曲
  const newSongs = songLibrary.filter(song =>
    ids.includes(song.id) &&
    !isInInventory(song.id) &&
    !shopSongs.some(s => s.id === song.id)
  );

  //追加到商店列表中
  shopSongs = shopSongs.concat(newSongs);

  renderShop();
  updatePracticeInfo();
}

//需要弹窗的时间点
const cardSongConfirmTimes = [
  "第二年一月前半",
  "第二年七月前半",
  "第三年一月前半",
  "第三年七月前半"
];

//时间顺序表
const timeOrder = [
  "出道战倒数第八个回合后",
  "第二年一月前半",
  "第二年七月前半",
  "第三年一月前半",
  "第三年七月前半"
];


function renderShop() {
  const shop = document.getElementById("shop");
  shop.innerHTML = "";

  [...shopSongs]
    .sort((a, b) => b.priority - a.priority)
    .forEach(song => {
      shop.appendChild(
        renderSongCard(song, {
          clickable: true,
          onClick: () => buySong(song.id),
          showPriority: true,
          showSuggest: true
        })
      );
    });


  const suggestTotal = calcSuggestCost();
  document.getElementById("suggestCost").innerHTML =
    renderTokenSummary(suggestTotal);

    renderTokenDiff();

}

 // 建议购买代币统计
function calcSuggestCost() {
  const total = { Da:0, Pa:0, Vo:0, Vi:0, Me:0 };

  shopSongs
    .filter(song => song.suggest)
    .forEach(song => {
      for (let k in total) {
        total[k] += song.cost[k];
      }
    });

  return total;
}



function buySong(id) {
  const song = shopSongs.find(s=>s.id===id);
  if (!song) return;

  // 扣代币
  for (let k in song.cost) {
    const input = document.getElementById(k);
    input.value = parseInt(input.value) - song.cost[k];
  }

  inventory.push(song);
  shopSongs = shopSongs.filter(s => s.id !== id);

  if (ignoreNextBuyCount) {
    ignoreNextBuyCount = false;
  } else {
    buyCount++;
  }

  renderInventory();
  renderShop();
  updatePracticeInfo();
  showBuySuccess(song.name);
  renderTokenDiff();


}

//通用代币展示函数
function renderCost(cost) {
  return `
    <div class="token-row">
      ${Object.keys(cost).map(k =>
        `<span><img src="./coinpng/${k}.png"> ${cost[k]}</span>`
      ).join("")}
    </div>
  `;
}

//通用卡片歌曲函数
function renderSongCard(song, options = {}) {
  const {
    clickable = false,
    onClick = null,
    showPriority = false,
    showSuggest = false
  } = options;

  const div = document.createElement("div");
  div.className = "song-card";
  if (clickable && onClick) div.onclick = onClick;

  div.innerHTML = `
    <img class="song-cover" src="./songcover/${song.cover}">
    <div class="song-info">
      <div class="song-title">${song.name}</div>
      ${renderEffect(song.effect)}
      ${renderCost(song.cost)}
      <div>
        ${showPriority ? `<span class="tag tag-priority">优先级 ${song.priority}</span>` : ""}
        ${showSuggest && song.suggest ? `<span class="tag tag-suggest">建议购买</span>` : ""}
      </div>
    </div>
  `;
  return div;
}


function renderInventory() {
  const inv = document.getElementById("inventory");
  inv.innerHTML = "";

  inventory.forEach(song => {
    inv.appendChild(
      renderSongCard(song, {
        clickable: true,
        onClick: () => refundSong(song.id)
      })
    );
  });

  document.getElementById("buyCount").innerText = buyCount;
}


function refundSong(id) {
  const song = inventory.find(s=>s.id===id);
  if (!song) return;

  for (let k in song.cost) {
    const input = document.getElementById(k);
    input.value = parseInt(input.value) + song.cost[k];
  }

  inventory = inventory.filter(s=>s.id!==id);
  shopSongs.push(song);
  buyCount--;

  renderInventory();
  renderShop();
  updatePracticeInfo();
  renderTokenDiff();

}

function updatePracticeInfo() {
  // 当前买歌前所需练习
  const currentRow = practiceTable.find(
    r => r.time === currentTime && r.buy === buyCount
  );

  document.getElementById("needPractice").innerText =
    currentRow ? currentRow.need : "未定义";

  // 买完当前歌曲后 → 下一首歌之间所需练习
  const nextRow = practiceTable.find(
    r => r.time === currentTime && r.buy === buyCount + 1
  );

  document.getElementById("nextNeedPractice").innerText =
    nextRow
      ? nextRow.need === null
        ? "不可再购买"
        : nextRow.need
      : "未定义";
}


//这里是建议购买歌曲总消耗代币展示图标
function renderTokenSummary(cost) {
  return `
    <div class="token-row">
      ${Object.keys(cost).map(k =>
        `<span><img src="./coinpng/${k}.png"> ${cost[k]}</span>`
      ).join("")}
    </div>
  `;
}

//屎山这一块
function isInInventory(songId) {
  return inventory.some(s => s.id === songId);
}

function resetPage() {
  location.reload();
}

// 卡歌确认弹窗处理函数
function handleCardSongConfirm(time) {
  isCardSongMode = false;
  ignoreNextBuyCount = false;

  if (cardSongConfirmTimes.includes(time)) {
    const result = confirm(
      "您卡歌了吗？ 卡歌的话下一次购买歌曲将不计入次数。"
    );

    if (result) {
      isCardSongMode = true;
      ignoreNextBuyCount = true;
    }
  }
}

//效果展示函数
function renderEffect(effect) {
  if (!effect) return "";

  let html = "";

  if (effect.instant) {
    html += `<div class="song-effect">
      <strong>即时效果：</strong>${effect.instant}
    </div>`;
  }

  if (effect.afterLive) {
    html += `<div class="song-effect">
      <strong>演出后效果：</strong>${effect.afterLive}
    </div>`;
  }

  return html;
}

//不可点击已经购买的歌曲
function onTimeButtonClick(btn) {
  const time = btn.dataset.time;
  if (disabledTimes.has(time)) return;

  // 当前按钮禁用
  disabledTimes.add(time);
  btn.classList.add("disabled");
  btn.disabled = true;

  handleCardSongConfirm(time);
  setTime(time);

  // 解锁下一个时间节点
  const index = timeOrder.indexOf(time);
  if (index !== -1 && index < timeOrder.length - 1) {
    const nextTime = timeOrder[index + 1];
    const nextBtn = document.querySelector(`button[data-time="${nextTime}"]`);
    if (nextBtn) {
      nextBtn.disabled = false;
      nextBtn.classList.remove("disabled");
    }
  }
}


//渲染代币差值
function renderTokenDiff() {
  const diffDiv = document.getElementById("tokenDiff");
  if (!diffDiv) return;

  const suggest = calcSuggestCost();

  const current = {
    Da: parseInt(document.getElementById("Da").value) || 0,
    Pa: parseInt(document.getElementById("Pa").value) || 0,
    Vo: parseInt(document.getElementById("Vo")?.value || 0),
    Vi: parseInt(document.getElementById("Vi").value) || 0,
    Me: parseInt(document.getElementById("Me").value) || 0
  };

  diffDiv.innerHTML = `
    <div class="token-diff-row">
      ${Object.keys(current).map(k => {
        const diff = current[k] - (suggest[k] || 0);
        return `
          <span class="${diff < 0 ? "token-negative" : ""}">
            <img src="./coinpng/${k}.png">
            ${diff >= 0 ? diff : `-${Math.abs(diff)}`}
          </span>
        `;
      }).join("")}
    </div>
  `;
}



// Wiki 页面渲染
(function renderWiki() {
  const view = document.getElementById("songLibraryView");
  view.innerHTML = "";

  songLibrary.forEach(song => {
    view.appendChild(
      renderSongCard(song, {
        showPriority: true,
        showSuggest: true
      })
    );
  });
})();

//监听
["Da","Pa","Vo","Vi","Me"].forEach(id => {
  const el = document.getElementById(id);
  if (el) {
    el.addEventListener("input", renderTokenDiff);
  }
});

//练习表的提取时间点
function getPracticeTimes() {
  return [...new Set(practiceTable.map(p => p.time))];
}

//初始化下拉框
function initPracticeFilter() {
  const select = document.getElementById("practiceTimeSelect");
  select.innerHTML = "";

  getPracticeTimes().forEach(time => {
    const opt = document.createElement("option");
    opt.value = time;
    opt.textContent = time;
    select.appendChild(opt);
  });

  select.addEventListener("change", () => {
    renderPracticeTable(select.value);
  });

  // 默认显示第一个时间
  if (select.value) {
    renderPracticeTable(select.value);
  }
}

//练习表渲染
function renderPracticeTable(time) {
  const tbody = document.querySelector("#practiceTable tbody");
  tbody.innerHTML = "";

  practiceTable
    .filter(row => row.time === time)
    .sort((a, b) => a.buy - b.buy)
    .forEach(row => {
      const tr = document.createElement("tr");

      const buyTd = document.createElement("td");
      buyTd.textContent = row.buy;

      const needTd = document.createElement("td");
      needTd.textContent =
        row.need === null ? "—（不可购买）" : row.need;

      if (row.need === null) {
        needTd.style.color = "#c00000";
      }

      tr.appendChild(buyTd);
      tr.appendChild(needTd);
      tbody.appendChild(tr);
    });
}

function openHelp() {
  document.getElementById("helpMask").classList.remove("modal-hidden");
}

function closeHelp() {
  document.getElementById("helpMask").classList.add("modal-hidden");
}


// ===== 页面初始化 =====
initPracticeFilter();

document.addEventListener("DOMContentLoaded", () => {
  const mask = document.getElementById("usageMask");
  const btn = document.getElementById("agreeBtn");

  btn.addEventListener("click", () => {
    mask.style.display = "none";
  });
});
// 初始时间节点按钮
function initTimeButtons() {
  const buttons = document.querySelectorAll("button[data-time]");

  buttons.forEach(btn => {
    const time = btn.dataset.time;
    if (time !== timeOrder[0]) {
      btn.disabled = true;
      btn.classList.add("disabled");
    }
  });
}

initTimeButtons();



</script>

<div id="toast"></div>
<!-- 使用声明遮罩 -->
<div id="usageMask">
  <div id="usageModal">
    <h2>使用声明</h2>

    <div class="usage-content">
      <p>1. 本工具为《闪耀！优俊少女》「偶像杯」策略辅助工具，仅用于参考。</p>
      <p>2. 所有数据来源于赛马娘wiki以及炮姐攻略，请以实际游戏为准。</p>
      <a href="https://www.bilibili.com/video/BV1kRkbB4EwK" target=_blank>3. 工具简单介绍视频点我</a>
      <p>4. 本工具不提供任何读取游戏数据、修改游戏数据、影响游戏公平性的功能。</p>
      <p>5. 使用本工具所产生的任何后果由使用者自行承担。</p>
      <p>6. 本工具中的“建议购买”仅适用于三速二智一友人的标准配卡，其他配卡请自行抉择</p>
      <p>7. 本工具完全免费，有兴趣可以给up点个关注喵~</p>

      <a href="https://space.bilibili.com/346993908" target=_blank>→点击进入up主页</a>
    </div>

    <button id="agreeBtn">我已知晓并同意</button>
  </div>
</div>
<!-- 使用说明弹窗 -->
<div id="helpMask" class="modal-hidden">
  <div id="usageMask">
    <div id="usageModal">
      <h2>使用说明</h2>

      <div class="usage-content">
        <p>1. 每次刷歌，点击右边对应的时间节点，就会把这个时间节点刷的歌加进商店。</p>
        <p>2. 点击歌曲即可购买，点击库存区的歌就可以退款。</p>
        <p>3. 选择新时间节点，卡歌弹窗要如实选择，否则练习次数计算会出现偏差。</p>
        <p>4. 游戏买歌的过程中，在库存区输入当前代币，就会计算还能将多少代币用于买课程。</p>
        <p>5. 如果有任何疑问或bug，欢迎点击页面下方的up主页联系我</p>
        <p>6. 祝大家都能养出心仪的小马</p>
      </div>

      <button class="modal-close-btn" onclick="closeHelp()">我知道了</button>
    </div>
  </div>
</div>

<!-- 页面底部信息栏 -->
<div class="footer">
  © 作者 bilibili 主页：
  <a href="https://space.bilibili.com/346993908" target="_blank">
    5h1gure_Ri0
  </a>

  <span class="footer-sep">|</span>

  <a href="https://github.com/408782683/Umamusume-Grand-Live-Song-Calculator/blob/main/index.html"
     target="_blank">
    GitHub 项目地址
  </a>

  <span class="footer-sep">|</span>

<a href="javascript:void(0)" onclick="openHelp()">
  使用说明
</a>

</div>


</body>

</html>
